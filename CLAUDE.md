# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is Tobias Maier's Dev Container Features collection - a repository for creating and distributing custom development container features following the [Dev Container Features specification](https://containers.dev/implementors/features/). Features are self-contained, reusable units that add tooling, runtimes, or libraries to development containers.

## Repository Structure

```
├── src
│   ├── <feature-name>
│   │   ├── devcontainer-feature.json    # Feature metadata and options
│   │   ├── install.sh                   # Installation script (runs as root)
│   │   ├── NOTES.md                     # Feature documentation content
│   │   └── README.md                    # Auto-generated documentation
│   └── ...
├── test
│   ├── _global                          # Global test scenarios
│   │   ├── scenarios.json
│   │   └── *.sh
│   ├── <feature-name>                   # Feature-specific tests
│   │   ├── scenarios.json
│   │   └── *.sh
│   └── ...
└── .github/workflows                    # CI/CD workflows
```

## Available Features

- `adr-tools` - Architecture Decision Records tools
- `chrome` - Google Chrome installation
- `claude-code` - Claude Code CLI for AI-powered development assistance
- `codex` - OpenAI Codex CLI for local AI-powered coding assistance
- `imagemagick` - ImageMagick image processing tools
- `mc` - MinIO Client for object storage
- `mcp-language-server` - MCP Language Server for semantic code navigation
- `typst` - Typst markup-based typesetting system
- `yek` - Repository serialization tool for LLMs
- `yq` - YAML processing tool

## Feature Development

### Feature Metadata (`devcontainer-feature.json`)
- **Required fields**: `id`, `name`, `version` (semver)
- **Optional fields**: `description`, `options`, `installsAfter`, `dependsOn`
- Options are passed as environment variables to install.sh (capitalized and sanitized)

### Development Workflow

1. **Create Feature**: Add new directory in `src/` with required files
2. **Define Options**: Configure in `devcontainer-feature.json` 
3. **Implement Installation**: Write `install.sh` script
4. **Add Tests**: Create test scenarios in `test/<feature-name>/`
5. **Validate**: Run validation to check feature definitions
6. **Test**: Run feature tests against different base images

### Creating a New Feature - Complete Guide

When creating a new feature, you need to create the following files and update existing ones:

#### Files to Create:
1. **`src/<feature-name>/devcontainer-feature.json`** - Feature metadata and configuration
2. **`src/<feature-name>/install.sh`** - Installation script (must be executable)
3. **`src/<feature-name>/NOTES.md`** - Feature documentation content
4. **`test/<feature-name>/scenarios.json`** - Test scenario configurations
5. **`test/<feature-name>/*.sh`** - Test scripts for each scenario (must be executable)

#### Files to Update:
1. **`CLAUDE.md`** - Add the new feature to the "Available Features" list
2. **`README.md`** - Add the new feature to the features table
3. **`.github/workflows/test.yaml`** - Add the new feature to the test matrix

**Note**: The `src/<feature-name>/README.md` file is auto-generated by the release workflow and should NOT be created manually.

### Options Handling

All available options for a Feature should be declared in the `devcontainer-feature.json`. Options are exported as Feature-scoped environment variables that are capitalized and sanitized according to [option resolution](https://containers.dev/implementors/features/#option-resolution).

Example option definition:
```jsonc
{
    "options": {
        "favorite": {
            "type": "string",
            "enum": ["red", "gold", "green"],
            "default": "red",
            "description": "Choose your favorite color."
        }
    }
}
```

Usage in install.sh:
```bash
#!/bin/bash
echo "The provided favorite color is: ${FAVORITE}"
```

## Testing and Validation

### Test Structure
Tests are organized in the `test/` directory with:
- `test/<feature-name>/` - Feature-specific test scenarios
- `test/_global/` - Global scenarios combining multiple features

Each test directory contains:
- `scenarios.json` - Test configurations with different options and base images
- `*.sh` - Test scripts that verify feature functionality

### Test Scripts
Test scripts follow this pattern:
```bash
#!/bin/bash
set -e

# Import test library
source dev-container-features-test-lib

# Test the installed functionality
check "description" bash -c "command | grep 'expected-output'"

# Report results
reportResults
```

### Key Commands

#### Testing Features
```bash
# Install devcontainer CLI (required for testing)
npm install -g @devcontainers/cli

# Test all features against multiple base images
devcontainer features test --skip-scenarios -f <feature-name> -i <base-image> .

# Test specific feature scenarios
devcontainer features test -f <feature-name> --skip-autogenerated --skip-duplicated .

# Test global scenarios (multiple features together)
devcontainer features test --global-scenarios-only .
```

#### Validation
```bash
# Validate all devcontainer-feature.json files
devcontainer features validate ./src
```

## Distribution and Publishing

Features are automatically published to GitHub Container Registry (GHCR) via GitHub Actions with the following setup:

### Versioning
- Features are individually versioned by the `version` attribute in `devcontainer-feature.json`
- Features follow semver specification
- Each feature is prefixed with `ghcr.io/tmaier/devcontainer-features` namespace
- A metadata package is also published containing information for feature discovery tools

### GitHub Actions Workflows
- **Release workflow** (`.github/workflows/release.yaml`): Publishes features to GHCR and auto-generates README.md files (manual trigger)
- **Validation workflow** (`.github/workflows/validate.yml`): Validates feature definitions on PRs
- **Testing workflow** (`.github/workflows/test.yaml`): Tests features on push/PR

## Documentation Guidelines

- For each feature, we maintain a README.md
- README.md files are auto-generated by the release GitHub workflow (see `.github/workflows/release.yaml`)
- A `NOTES.md` file must be maintained for each feature, as it will be included in the auto-generated README.md
- Example of inclusion can be seen in `src/chrome/README.md` which references `src/chrome/NOTES.md`
